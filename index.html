<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Star Games</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  :root {
    --bg-dark: #111114;
    --bg-card: #19191f;
    --card-bg: rgba(22,22,32,0.85);
    --card-border: rgba(255,255,255,0.06);
    --green: #00e676;
    --green-dim: #00c853;
    --red: #ff1744;
    --red-dim: #d50000;
    --accent: #7c4dff;
    --accent-dim: #651fff;
    --text: #f0f0f5;
    --text-dim: #8e8ea0;
    --gold: #ffd600;
  }

  body {
    font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
    background:var(--bg-dark);
    background-image:url('https://ltdfoto.ru/images/2026/01/17/sadx.jpg');
    background-size:100% 100%;
    background-position:center;
    background-repeat:no-repeat;
    background-attachment:fixed;
    color:var(--text);
    overflow-x:hidden;
    min-height:100vh;
    position:relative;
  }

  .app {
    position:relative; z-index:2;
    max-width:576px; margin:0 auto;
    padding:0 10px 80px;
    min-height:100vh;
    display:flex; flex-direction:column;
  }

  /* Login Overlay */
  .login-overlay {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.92);
    z-index:500;
    display:flex; align-items:center; justify-content:center;
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
  }
  .login-overlay.hidden { display:none; }
  .login-box {
    background:var(--bg-card);
    border:1px solid var(--card-border);
    border-radius:24px;
    padding:40px 32px;
    text-align:center;
    max-width:340px;
    width:90%;
  }
  .login-box h2 { font-size:22px; font-weight:800; margin-bottom:8px; }
  .login-box p { font-size:13px; color:var(--text-dim); margin-bottom:24px; }
  .login-input {
    width:100%; background:rgba(255,255,255,0.06);
    border:2px solid var(--card-border); border-radius:14px;
    padding:14px 16px; color:var(--text); font-size:16px; font-weight:600;
    outline:none; font-family:inherit; transition:border-color 0.2s;
    margin-bottom:16px; text-align:center;
  }
  .login-input:focus { border-color:var(--accent); }
  .login-input::placeholder { color:var(--text-dim); font-weight:400; }
  .login-btn {
    width:100%; padding:14px; border-radius:14px; border:none;
    background:var(--accent); color:#fff;
    font-family:inherit; font-size:16px; font-weight:700; cursor:pointer;
    box-shadow:0 4px 24px rgba(124,77,255,0.35); transition:transform 0.15s;
  }
  .login-btn:active { transform:scale(0.97); }
  .login-btn:disabled { opacity:0.5; cursor:default; }
  .login-avatar-preview {
    width:64px; height:64px; border-radius:50%;
    background:rgba(124,77,255,0.2);
    display:flex; align-items:center; justify-content:center;
    font-size:28px; font-weight:900; color:var(--accent);
    margin:0 auto 16px;
    border:2px solid var(--accent);
  }

  /* Island (balance) */
  .island {
    margin:12px auto 10px;
    background:rgba(0,0,0,0.7);
    border:1px solid var(--card-border);
    border-radius:28px;
    padding:8px 24px;
    display:flex; align-items:center; justify-content:center; gap:8px;
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    min-width:140px; width:fit-content;
    cursor:pointer;
    transition:background 0.2s;
  }
  .island:hover { background:rgba(0,0,0,0.85); }
  .island .star-icon { width:20px; height:20px; flex-shrink:0; }
  .island .balance-text { font-size:16px; font-weight:700; letter-spacing:0.02em; }
  .island .plus-icon {
    width:18px; height:18px; border-radius:50%;
    background:var(--accent); display:flex; align-items:center; justify-content:center;
    font-size:14px; font-weight:700; color:#fff; flex-shrink:0;
  }

  /* Deposit Modal */
  .deposit-overlay {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    z-index:200;
    display:flex; align-items:center; justify-content:center;
    backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
    opacity:0; pointer-events:none; transition:opacity 0.3s;
  }
  .deposit-overlay.visible { opacity:1; pointer-events:auto; }
  .deposit-box {
    background:#1e1e26;
    border:1px solid var(--card-border);
    border-radius:24px;
    padding:32px 24px;
    text-align:center;
    max-width:360px;
    width:90%;
  }
  .deposit-box h3 { font-size:20px; font-weight:800; margin-bottom:16px; }
  .deposit-method {
    padding:16px; border-radius:16px;
    background:rgba(255,255,255,0.06);
    border:2px solid transparent;
    cursor:pointer;
    transition:border-color 0.2s, background 0.2s;
    margin-bottom:12px;
    display:flex; align-items:center; gap:12px;
  }
  .deposit-method:hover, .deposit-method.selected { border-color:var(--accent); background:rgba(124,77,255,0.12); }
  .deposit-method img { width:32px; height:32px; }
  .deposit-method-info { text-align:left; }
  .deposit-method-info .dm-title { font-size:15px; font-weight:700; }
  .deposit-method-info .dm-desc { font-size:11px; color:var(--text-dim); }
  .deposit-instructions {
    margin-top:12px; padding:16px;
    background:rgba(255,214,0,0.08);
    border:1px solid rgba(255,214,0,0.2);
    border-radius:14px;
    font-size:13px; color:var(--gold);
    line-height:1.5;
    display:none;
  }
  .deposit-instructions.visible { display:block; }
  .deposit-instructions a { color:var(--accent); font-weight:700; text-decoration:none; }
  .deposit-close-btn {
    margin-top:16px; padding:12px 32px; border-radius:14px; border:none;
    background:rgba(255,255,255,0.08); color:var(--text);
    font-family:inherit; font-size:14px; font-weight:600; cursor:pointer;
  }

  /* ===== SECTIONS SLIDER ===== */
  .sections-wrapper {
    flex:1;
    overflow:hidden;
    position:relative;
  }
  .sections-track {
    display:flex;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    will-change:transform;
    width:400%;
  }
  .section {
    width:25%;
    flex-shrink:0;
    padding:0;
  }

  /* ===== BOTTOM NAV ===== */
  .bottom-nav {
    position:fixed;
    bottom:0; left:0; right:0;
    z-index:50;
    background:rgba(17,17,20,0.95);
    border-top:1px solid var(--card-border);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    display:flex;
    max-width:576px;
    margin:0 auto;
    padding:8px 6px 12px;
  }
  .nav-btn {
    flex:1;
    background:none; border:none;
    display:flex; flex-direction:column;
    align-items:center; gap:4px;
    padding:6px 4px;
    cursor:pointer;
    color:var(--text-dim);
    font-family:inherit; font-size:11px; font-weight:600;
    transition:color 0.2s;
  }
  .nav-btn.active { color:var(--accent); }
  .nav-btn svg { width:22px; height:22px; }

  /* ===== HOME SECTION ===== */
  .home-wrapper {
    padding:10px 4px;
    display:flex; flex-direction:column; align-items:center; gap:16px;
  }
  .home-player-card {
    width:100%;
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:20px;
    padding:24px 20px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
    display:flex; align-items:center; gap:16px;
  }
  .home-avatar {
    width:56px; height:56px; border-radius:50%;
    background:linear-gradient(135deg, var(--accent), #651fff);
    display:flex; align-items:center; justify-content:center;
    font-size:24px; font-weight:900; color:#fff;
    flex-shrink:0;
    border:2px solid rgba(124,77,255,0.5);
  }
  .home-player-info { flex:1; }
  .home-player-name { font-size:18px; font-weight:800; margin-bottom:4px; }
  .home-player-balance {
    font-size:14px; color:var(--text-dim); font-weight:600;
    display:flex; align-items:center; gap:4px;
  }
  .home-player-balance img { width:16px; height:16px; }

  .home-games-title {
    font-size:14px; font-weight:700; color:var(--text-dim);
    text-transform:uppercase; letter-spacing:1.5px;
    align-self:flex-start; margin-top:4px;
  }
  .home-games-grid {
    width:100%;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }
  .home-game-card {
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:18px;
    overflow:hidden;
    cursor:pointer;
    transition:transform 0.2s, box-shadow 0.3s;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  }
  .home-game-card:hover { transform:translateY(-2px); }
  .home-game-card:active { transform:scale(0.97); }
  .home-game-img {
    width:100%; height:100px; object-fit:cover;
    border-bottom:1px solid var(--card-border);
  }
  .home-game-info { padding:12px; }
  .home-game-name { font-size:15px; font-weight:700; margin-bottom:4px; }
  .home-game-desc { font-size:11px; color:var(--text-dim); }
  .home-game-card.trading-card { box-shadow:0 4px 20px rgba(0,230,118,0.1); border-color:rgba(0,230,118,0.15); }
  .home-game-card.cases-card { box-shadow:0 4px 20px rgba(255,214,0,0.1); border-color:rgba(255,214,0,0.15); }
  .home-game-card.crash-card { box-shadow:0 4px 20px rgba(255,23,68,0.1); border-color:rgba(255,23,68,0.15); }

  .home-deposit-btn {
    width:100%; padding:16px; border-radius:16px; border:none;
    background:linear-gradient(135deg, var(--accent), #651fff);
    color:#fff;
    font-family:inherit; font-size:16px; font-weight:700; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 24px rgba(124,77,255,0.35); transition:transform 0.15s;
    margin-top:4px;
  }
  .home-deposit-btn:active { transform:scale(0.97); }
  .home-deposit-btn img { width:20px; height:20px; }

  /* ===== CHART / TRADING ===== */
  .chart-bg-gif {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:0; overflow:hidden; border-radius:18px;
  }
  .chart-bg-gif img { width:100%; height:100%; object-fit:cover; opacity:0.3; }
  .chart-bg-overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:linear-gradient(180deg,rgba(17,17,20,0.4) 0%,rgba(17,17,20,0.7) 100%);
    z-index:1; border-radius:18px;
  }

  .mood-row { display:flex; justify-content:center; gap:8px; margin-bottom:10px; }
  .mood-card {
    width:80px; height:80px;
    background:var(--card-bg); border:1px solid var(--card-border);
    border-radius:16px; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    transition:box-shadow 0.4s;
  }
  .mood-card img { width:64px; height:64px; object-fit:contain; }
  .mood-card.crash-mood { box-shadow:0 0 18px 4px rgba(255,23,68,0.25); border-color:rgba(255,23,68,0.3); }

  .multiplier-display {
    text-align:center; margin-bottom:6px; min-height:52px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .multiplier-value { font-size:42px; font-weight:900; letter-spacing:-1px; transition:color 0.3s; }
  .multiplier-value.green { color:var(--green); }
  .multiplier-value.red { color:var(--red); }
  .multiplier-value.crashed { color:var(--red); animation:shake 0.4s ease; }
  .multiplier-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.5px; margin-top:2px; }

  @keyframes shake {
    0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)}
  }

  .chart-container {
    width:100%; aspect-ratio:1.92/1;
    background:var(--bg-card); border:1px solid var(--card-border);
    border-radius:18px; overflow:hidden; position:relative; margin-bottom:12px;
  }
  .chart-container canvas { width:100%; height:100%; display:block; position:relative; z-index:2; }

  .timer-bar-wrap { height:4px; background:rgba(255,255,255,0.08); border-radius:2px; margin-bottom:12px; overflow:hidden; }
  .timer-bar { height:100%; border-radius:2px; transition:width 0.3s linear,background 0.3s; background:var(--green); }

  .countdown-overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:rgba(17,17,20,0.75);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    z-index:5; border-radius:18px;
    opacity:0; pointer-events:none; transition:opacity 0.3s;
  }
  .countdown-overlay.visible { opacity:1; pointer-events:auto; }
  .countdown-number { font-size:64px; font-weight:900; color:var(--accent); animation:pulse 1s infinite; }
  .countdown-label { font-size:13px; color:var(--text-dim); margin-top:4px; letter-spacing:1px; text-transform:uppercase; }

  @keyframes pulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.15);opacity:0.7} }

  .action-btn {
    width:100%; padding:16px; border-radius:16px; border:none;
    font-family:inherit; font-size:17px; font-weight:700; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px;
    transition:transform 0.15s,background 0.2s,box-shadow 0.3s;
    margin-bottom:10px; position:relative; overflow:hidden;
  }
  .action-btn:active { transform:scale(0.97); }
  .action-btn .star-icon { width:22px; height:22px; }
  .action-btn.play-btn { background:var(--accent); color:#fff; box-shadow:0 4px 24px rgba(124,77,255,0.35); }
  .action-btn.cashout-btn { background:var(--green); color:#0d0d12; box-shadow:0 4px 24px rgba(0,230,118,0.35); animation:glow-green 1.5s infinite alternate; }
  .action-btn.cashout-btn.down { background:var(--red); color:#fff; box-shadow:0 4px 24px rgba(255,23,68,0.35); animation:glow-red 1.5s infinite alternate; }
  .action-btn.waiting-btn { background:rgba(255,255,255,0.08); color:var(--text-dim); cursor:default; box-shadow:none; }
  .action-btn.crashed-btn { background:var(--red); color:#fff; box-shadow:0 4px 24px rgba(255,23,68,0.35); }

  @keyframes glow-green { from{box-shadow:0 4px 24px rgba(0,230,118,0.25)} to{box-shadow:0 4px 32px rgba(0,230,118,0.55)} }
  @keyframes glow-red { from{box-shadow:0 4px 24px rgba(255,23,68,0.25)} to{box-shadow:0 4px 32px rgba(255,23,68,0.55)} }

  /* ===== PLAYERS PANEL ===== */
  .players-panel {
    background:var(--card-bg); border:1px solid var(--card-border);
    border-radius:18px; padding:14px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  }
  .players-header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:10px;
  }
  .players-header-left, .players-header-right {
    font-size:12px; color:var(--text-dim); text-transform:uppercase;
    letter-spacing:1.2px; font-weight:600;
    display:flex; align-items:center; gap:4px;
  }
  .players-header-right .star-icon { width:12px; height:12px; }
  .player-row {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.04);
    border-radius:10px; transition:background 0.4s;
  }
  .player-row:last-child { border-bottom:none; }
  .player-row.player-you { background:rgba(255,214,0,0.10); border:1px solid rgba(255,214,0,0.25); }
  .player-row.player-won-bg { background:rgba(0,230,118,0.10); }
  .player-row.player-lost-bg { background:rgba(255,23,68,0.10); }
  .player-info { display:flex; align-items:center; gap:8px; }
  .player-avatar {
    width:30px; height:30px; border-radius:50%;
    background:rgba(124,77,255,0.2);
    display:flex; align-items:center; justify-content:center;
    font-size:13px; font-weight:700; color:var(--accent);
  }
  .player-avatar.you-avatar { background:rgba(255,214,0,0.25); color:var(--gold); }
  .player-name { font-size:13px; font-weight:600; }
  .player-name.you-name { color:var(--gold); }
  .player-details { font-size:11px; color:var(--text-dim); display:flex; align-items:center; gap:6px; }
  .player-details .star-icon { width:11px; height:11px; }
  .player-cashout-info { font-size:11px; font-weight:600; }
  .player-cashout-info.win { color:var(--green); }
  .player-cashout-info.lose { color:var(--red); }
  .player-cashout-info.playing { color:var(--text-dim); }
  .player-result { font-size:13px; font-weight:700; display:flex; align-items:center; gap:3px; }
  .player-result .star-icon { width:13px; height:13px; }
  .player-result.win { color:var(--green); }
  .player-result.lose { color:var(--red); }
  .player-result.playing { color:var(--gold); }

  .canvas-nick-float {
    position:absolute; z-index:10;
    font-size:11px; font-weight:700; color:var(--green);
    text-shadow:0 0 8px rgba(0,230,118,0.5);
    pointer-events:none; opacity:0; transition:opacity 0.5s;
  }
  .canvas-nick-float.show { opacity:1; }
  .canvas-nick-float.hide { opacity:0; }

  .history-row {
    display:flex; gap:6px; margin-bottom:10px;
    overflow-x:auto; padding-bottom:4px;
  }
  .history-row::-webkit-scrollbar { display:none; }
  .history-chip {
    padding:4px 10px; border-radius:8px;
    font-size:12px; font-weight:700; white-space:nowrap; flex-shrink:0;
  }
  .history-chip.green { background:rgba(0,230,118,0.15); color:var(--green); }
  .history-chip.red { background:rgba(255,23,68,0.15); color:var(--red); }

  /* ===== BOTTOM SHEET ===== */
  .sheet-backdrop {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0); z-index:100;
    pointer-events:none; transition:background 0.35s ease;
  }
  .sheet-backdrop.visible { background:rgba(0,0,0,0.6); pointer-events:auto; }
  .bottom-sheet {
    position:fixed; bottom:0; left:0; width:100%; z-index:101;
    transform:translateY(100%);
    transition:transform 0.35s cubic-bezier(0.32,0.72,0,1);
    will-change:transform;
  }
  .bottom-sheet.visible { transform:translateY(0); }
  .bottom-sheet.dragging { transition:none; }
  .sheet-content {
    background:#1e1e26; border-radius:20px 20px 0 0;
    padding:0 20px 32px; max-width:576px; margin:0 auto;
    width:100%; max-height:85vh; overflow-y:auto;
  }
  .sheet-handle-area {
    display:flex; align-items:center; justify-content:center;
    padding:12px 0 16px; cursor:grab; touch-action:none;
  }
  .sheet-handle-area:active { cursor:grabbing; }
  .sheet-handle { width:40px; height:5px; border-radius:3px; background:rgba(255,255,255,0.35); }
  .sheet-title { text-align:center; font-size:18px; font-weight:700; margin-bottom:20px; }
  .sheet-section-label {
    font-size:12px; font-weight:600; color:var(--text-dim);
    text-transform:uppercase; letter-spacing:1.2px; margin-bottom:10px;
  }
  .bet-options { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
  .bet-option {
    padding:14px; border-radius:14px;
    background:rgba(255,255,255,0.06);
    border:2px solid transparent;
    font-family:inherit; font-size:16px; font-weight:700;
    color:var(--text); cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:6px;
    transition:border-color 0.2s,background 0.2s;
  }
  .bet-option:hover, .bet-option.selected { border-color:var(--accent); background:rgba(124,77,255,0.12); }
  .bet-option .star-icon { width:18px; height:18px; }
  .sheet-input-group { margin-bottom:16px; }
  .sheet-input {
    width:100%; background:rgba(255,255,255,0.06);
    border:2px solid var(--card-border); border-radius:14px;
    padding:14px 16px; color:var(--text); font-size:16px; font-weight:600;
    outline:none; font-family:inherit; transition:border-color 0.2s;
  }
  .sheet-input:focus { border-color:var(--accent); }
  .sheet-input::placeholder { color:var(--text-dim); font-weight:400; }
  .auto-cashout-sheet {
    display:flex; align-items:center; gap:10px; margin-bottom:20px;
    padding:12px 14px; background:rgba(255,255,255,0.04); border-radius:14px;
  }
  .auto-cashout-sheet label { font-size:13px; color:var(--text-dim); white-space:nowrap; font-weight:500; }
  .auto-cashout-sheet input {
    flex:1; background:rgba(255,255,255,0.06);
    border:1px solid var(--card-border); border-radius:10px;
    padding:10px 12px; color:var(--text); font-size:14px; font-weight:600;
    outline:none; font-family:inherit;
  }
  .auto-cashout-sheet input:focus { border-color:var(--accent); }
  .auto-cashout-toggle {
    width:44px; height:24px; border-radius:12px;
    background:rgba(255,255,255,0.1); border:none;
    position:relative; cursor:pointer; transition:background 0.2s; flex-shrink:0;
  }
  .auto-cashout-toggle.on { background:var(--accent); }
  .auto-cashout-toggle::after {
    content:''; position:absolute; top:3px; left:3px;
    width:18px; height:18px; border-radius:50%; background:#fff;
    transition:transform 0.2s;
  }
  .auto-cashout-toggle.on::after { transform:translateX(20px); }
  .sheet-confirm-btn {
    width:100%; padding:16px; border-radius:16px; border:none;
    background:var(--accent); color:#fff;
    font-family:inherit; font-size:17px; font-weight:700; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px;
    box-shadow:0 4px 24px rgba(124,77,255,0.35); transition:transform 0.15s;
  }
  .sheet-confirm-btn:active { transform:scale(0.97); }
  .sheet-confirm-btn .star-icon { width:20px; height:20px; }

  /* ===== CASES SECTION ===== */
  .cases-wrapper { padding:0 4px; }
  .cases-title { text-align:center; font-size:20px; font-weight:800; margin-bottom:16px; }

  .case-preview-card {
    background:var(--card-bg); border:1px solid var(--card-border);
    border-radius:20px; padding:20px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
    display:flex; flex-direction:column; align-items:center;
    cursor:pointer; transition:transform 0.2s, box-shadow 0.3s;
    margin-bottom:16px;
  }
  .case-preview-card:hover { transform:translateY(-2px); }
  .case-preview-card:active { transform:scale(0.97); }
  .case-preview-img {
    width:120px; height:120px; object-fit:contain;
    margin-bottom:12px;
    filter:drop-shadow(0 0 20px rgba(124,77,255,0.3));
  }
  .case-preview-name { font-size:17px; font-weight:800; margin-bottom:4px; }
  .case-preview-price {
    font-size:14px; font-weight:700; color:var(--gold);
    display:flex; align-items:center; gap:4px;
  }
  .case-preview-price img { width:16px; height:16px; }
  .case-preview-price.free-price { color:var(--green); }

  .case-card {
    background:var(--card-bg); border:1px solid var(--card-border);
    border-radius:18px; padding:16px; margin-bottom:16px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
    display:none;
  }
  .case-card.open { display:block; }
  .case-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
  .case-name { font-size:16px; font-weight:700; }
  .case-price { font-size:14px; font-weight:700; color:var(--gold); display:flex; align-items:center; gap:4px; }
  .case-price .star-icon { width:16px; height:16px; }
  .case-price.free-price { color:var(--green); }
  .case-back-btn {
    padding:8px 16px; border-radius:10px; border:none;
    background:rgba(255,255,255,0.08); color:var(--text);
    font-family:inherit; font-size:13px; font-weight:600; cursor:pointer;
    margin-bottom:12px;
  }

  /* Roulette spinner */
  .spinner-wrapper {
    position:relative; overflow:hidden;
    border-radius:14px; height:90px;
    background:rgba(0,0,0,0.3); margin-bottom:12px;
    border:1px solid var(--card-border);
  }
  .spinner-arrow {
    position:absolute; top:0; left:50%; transform:translateX(-50%);
    z-index:5; width:0; height:0;
    border-left:10px solid transparent; border-right:10px solid transparent;
    border-top:14px solid var(--gold);
    filter:drop-shadow(0 0 6px rgba(255,214,0,0.5));
  }
  .spinner-arrow-bottom {
    position:absolute; bottom:0; left:50%; transform:translateX(-50%);
    z-index:5; width:0; height:0;
    border-left:10px solid transparent; border-right:10px solid transparent;
    border-bottom:14px solid var(--gold);
    filter:drop-shadow(0 0 6px rgba(255,214,0,0.5));
  }
  .spinner-track {
    display:flex; align-items:center;
    position:absolute; top:0; left:0; height:100%;
    transition:none;
    will-change:transform;
  }
  .spinner-item {
    width:90px; height:90px; flex-shrink:0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center; gap:4px;
    border-right:1px solid rgba(255,255,255,0.06);
    font-size:13px; font-weight:700;
  }
  .spinner-item img { width:40px; height:40px; object-fit:contain; }
  .spinner-item .item-label { font-size:11px; color:var(--text-dim); }
  .spinner-highlight {
    position:absolute; top:0; left:50%; transform:translateX(-50%);
    width:90px; height:100%;
    border:2px solid var(--gold);
    border-radius:4px;
    z-index:4;
    pointer-events:none;
    box-shadow:inset 0 0 20px rgba(255,214,0,0.1);
  }

  .case-spin-btn {
    width:100%; padding:14px; border-radius:14px; border:none;
    font-family:inherit; font-size:16px; font-weight:700; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:6px;
    transition:transform 0.15s, opacity 0.2s;
    margin-bottom:12px;
  }
  .case-spin-btn:active { transform:scale(0.97); }
  .case-spin-btn .star-icon { width:18px; height:18px; }
  .case-spin-btn.free-btn { background:var(--green); color:#0d0d12; box-shadow:0 4px 20px rgba(0,230,118,0.3); }
  .case-spin-btn.paid-btn { background:var(--accent); color:#fff; box-shadow:0 4px 20px rgba(124,77,255,0.3); }
  .case-spin-btn:disabled { opacity:0.5; cursor:default; }
  .case-timer { text-align:center; font-size:13px; color:var(--text-dim); margin-bottom:8px; font-weight:600; }

  /* Drops preview */
  .drops-title { font-size:12px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .drops-grid { display:flex; gap:8px; overflow-x:auto; padding-bottom:6px; }
  .drops-grid::-webkit-scrollbar { display:none; }
  .drop-item {
    flex-shrink:0; width:70px;
    display:flex; flex-direction:column; align-items:center; gap:4px;
    padding:8px 4px; border-radius:10px;
    background:rgba(255,255,255,0.04); border:1px solid var(--card-border);
  }
  .drop-item img { width:32px; height:32px; object-fit:contain; }
  .drop-item .drop-amount { font-size:12px; font-weight:700; }
  .drop-item .drop-chance { font-size:9px; color:var(--text-dim); }

  /* Win popup */
  .win-popup {
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.8);
    background:rgba(22,22,32,0.95); border:2px solid var(--gold);
    border-radius:24px; padding:32px 40px; text-align:center;
    z-index:200; opacity:0; pointer-events:none;
    transition:opacity 0.3s, transform 0.3s;
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
  }
  .win-popup.visible { opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
  .win-popup img { width:64px; height:64px; margin-bottom:12px; }
  .win-popup .win-text { font-size:24px; font-weight:900; color:var(--gold); margin-bottom:8px; }
  .win-popup .win-amount { font-size:18px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:6px; }
  .win-popup .win-amount .star-icon { width:20px; height:20px; }
  .win-popup-close {
    margin-top:16px; padding:10px 32px; border-radius:12px; border:none;
    background:var(--accent); color:#fff; font-family:inherit; font-size:15px;
    font-weight:700; cursor:pointer;
  }

  /* ===== CRASH GAME (ROCKET) ===== */
  .crash-wrapper { padding:0 4px; }
  .crash-chart-container {
    width:100%; aspect-ratio:1.3/1;
    background:var(--bg-card); border:1px solid var(--card-border);
    border-radius:18px; overflow:hidden; position:relative; margin-bottom:12px;
  }
  .crash-chart-container canvas { width:100%; height:100%; display:block; position:relative; z-index:2; }
  .crash-bg-gif {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:0; overflow:hidden; border-radius:18px;
  }
  .crash-bg-gif img { width:100%; height:100%; object-fit:cover; opacity:0.3; }
  .crash-bg-overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:linear-gradient(180deg,rgba(17,17,20,0.4) 0%,rgba(17,17,20,0.7) 100%);
    z-index:1; border-radius:18px;
  }
  .crash-multiplier-display {
    text-align:center; margin-bottom:6px; min-height:52px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .crash-mult-value { font-size:42px; font-weight:900; letter-spacing:-1px; transition:color 0.3s; }
  .crash-mult-value.green { color:var(--green); }
  .crash-mult-value.red { color:var(--red); animation:shake 0.4s ease; }
  .crash-mult-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.5px; margin-top:2px; }

  .hidden { display:none !important; }

  /* Rocket/Explosion images in crash */
  .crash-rocket-img {
    position:absolute; z-index:10;
    width:200px; height:200px;
    object-fit:contain;
    pointer-events:none;
    transform:translate(-50%,-50%) rotate(0deg);
    transition:transform 0.15s ease-out;
  }
  .crash-explosion-img {
    position:absolute; z-index:10;
    width:300px; height:300px;
    object-fit:contain;
    pointer-events:none;
    transform:translate(-50%,-50%);
    display:none;
  }
  .crash-explosion-img.visible { display:block; }
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="login-avatar-preview" id="loginAvatarPreview">?</div>
    <h2>Star Games</h2>
    <p>Введите ваш @username в Telegram для входа</p>
    <input class="login-input" type="text" id="loginUsernameInput" placeholder="@username" autocomplete="off">
    <button class="login-btn" id="loginBtn" onclick="doLogin()" disabled>Войти</button>
  </div>
</div>

<!-- DEPOSIT OVERLAY -->
<div class="deposit-overlay" id="depositOverlay">
  <div class="deposit-box">
    <h3>Пополнение баланса</h3>
    <div class="deposit-method" id="depositMethodStars" onclick="selectDepositMethod('stars')">
      <img src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="stars">
      <div class="deposit-method-info">
        <div class="dm-title">Звезды Telegram</div>
        <div class="dm-desc">Пополнение через NFT/подарки</div>
      </div>
    </div>
    <div class="deposit-instructions" id="depositInstructions">
      Отправьте любой NFT/подарок на аккаунт <a href="https://t.me/obnalcontora" target="_blank">@obnalcontora</a> и вам зачислится его стоимость!
    </div>
    <button class="deposit-close-btn" onclick="closeDeposit()">Закрыть</button>
  </div>
</div>

<div class="app">
  <div class="island" onclick="openDeposit()">
    <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="star">
    <span class="balance-text" id="balanceDisplay">1000</span>
    <div class="plus-icon">+</div>
  </div>

  <div class="sections-wrapper">
    <div class="sections-track" id="sectionsTrack">

      <!-- ===== HOME SECTION ===== -->
      <div class="section" id="homeSection">
        <div class="home-wrapper">
          <div class="home-player-card">
            <div class="home-avatar" id="homeAvatar">?</div>
            <div class="home-player-info">
              <div class="home-player-name" id="homePlayerName">Player</div>
              <div class="home-player-balance">
                <img src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="">
                <span id="homeBalance">1000</span> звезд
              </div>
            </div>
          </div>

          <div class="home-games-title">Выбери игру</div>

          <div class="home-games-grid">
            <div class="home-game-card trading-card" onclick="switchSection(1)">
              <div style="width:100%;height:100px;background:linear-gradient(135deg,#0d2818,#19191f);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;">
                <img src="https://i.postimg.cc/vTxyCnfx/0219.gif" style="width:100%;height:100%;object-fit:cover;opacity:0.6;" alt="">
                <svg viewBox="0 0 24 24" fill="none" stroke="#00e676" stroke-width="2" style="position:absolute;width:40px;height:40px;filter:drop-shadow(0 0 8px rgba(0,230,118,0.5));"><path d="M3 3v18h18"/><path d="m7 16 4-8 4 4 5-6"/></svg>
              </div>
              <div class="home-game-info">
                <div class="home-game-name" style="color:var(--green);">Trading</div>
                <div class="home-game-desc">Торгуй свечами и зарабатывай</div>
              </div>
            </div>
            <div class="home-game-card cases-card" onclick="switchSection(2)">
              <div style="width:100%;height:100px;background:linear-gradient(135deg,#2a1f00,#19191f);display:flex;align-items:center;justify-content:center;overflow:hidden;">
                <img src="https://i.postimg.cc/Y9QpJwQN/ufafyafyaf.png" style="width:70px;height:70px;object-fit:contain;filter:drop-shadow(0 0 12px rgba(255,214,0,0.4));" alt="">
              </div>
              <div class="home-game-info">
                <div class="home-game-name" style="color:var(--gold);">Кейсы</div>
                <div class="home-game-desc">Открывай кейсы и получай призы</div>
              </div>
            </div>
            <div class="home-game-card crash-card" onclick="switchSection(3)" style="grid-column:1/3;">
              <div style="width:100%;height:100px;background:linear-gradient(135deg,#1a0a0a,#19191f);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;">
                <img src="https://i.postimg.cc/QxvmXD36/Animated-Ag-ADyxs-AAte-Jk-Us.gif" style="width:70px;height:70px;object-fit:contain;filter:drop-shadow(0 0 12px rgba(255,23,68,0.5));" alt="">
              </div>
              <div class="home-game-info">
                <div class="home-game-name" style="color:var(--red);">Краш</div>
                <div class="home-game-desc">Ракета летит вверх - успей забрать до взрыва!</div>
              </div>
            </div>
          </div>

          <button class="home-deposit-btn" onclick="openDeposit()">
            <img src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="">
            Пополнить баланс
          </button>
        </div>
      </div>

      <!-- ===== TRADING SECTION ===== -->
      <div class="section" id="tradingSection">
        <div class="history-row" id="historyRow"></div>
        <div class="mood-row">
          <div class="mood-card" id="mood1"><img src="https://emojio.ru/images/apple-b/1f559.png" alt="mood"></div>
          <div class="mood-card" id="mood2"><img src="https://emojio.ru/images/apple-b/1f559.png" alt="mood"></div>
          <div class="mood-card" id="mood3"><img src="https://emojio.ru/images/apple-b/1f559.png" alt="mood"></div>
        </div>
        <div class="multiplier-display">
          <div class="multiplier-value green" id="multiplierValue">1.00x</div>
          <div class="multiplier-label" id="multiplierLabel">Ожидание ставок...</div>
        </div>
        <div class="chart-container" id="chartContainer">
          <div class="chart-bg-gif"><img src="https://i.postimg.cc/vTxyCnfx/0219.gif" alt=""></div>
          <div class="chart-bg-overlay"></div>
          <canvas id="chartCanvas"></canvas>
          <div class="countdown-overlay" id="countdownOverlay">
            <div class="countdown-number" id="countdownNumber">3</div>
            <div class="countdown-label">Новый раунд</div>
          </div>
          <div id="floatingNicks"></div>
        </div>
        <div class="timer-bar-wrap"><div class="timer-bar" id="timerBar" style="width:100%"></div></div>
        <button class="action-btn play-btn" id="actionBtn" onclick="onActionClick()">
          <span id="actionText">СДЕЛАТЬ СТАВКУ</span>
          <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="star">
        </button>
        <div class="players-panel">
          <div class="players-header">
            <div class="players-header-left" id="playersCount">0 игроков</div>
            <div class="players-header-right" id="playersTotalBets">
              0 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="">
            </div>
          </div>
          <div id="playersList"></div>
        </div>
      </div>

      <!-- ===== CASES SECTION ===== -->
      <div class="section" id="casesSection">
        <div class="cases-wrapper">
          <div class="cases-title">Кейсы</div>

          <!-- Case previews (clickable cards with images) -->
          <div id="casePreviews">
            <div class="case-preview-card" onclick="openCase('free')">
              <img class="case-preview-img" src="https://i.postimg.cc/Y9QpJwQN/ufafyafyaf.png" alt="Free Case">
              <div class="case-preview-name">Бесплатный кейс</div>
              <div class="case-preview-price free-price">БЕСПЛАТ  О</div>
            </div>
          </div>

          <!-- Free case (hidden until clicked) -->
          <div class="case-card" id="freeCaseCard">
            <button class="case-back-btn" onclick="closeCaseView()">Назад к кейсам</button>
            <div class="case-header">
              <div class="case-name">Бесплатный кейс</div>
              <div class="case-price free-price">БЕСПЛАТНО</div>
            </div>
            <div class="spinner-wrapper" id="freeSpinnerWrapper">
              <div class="spinner-arrow"></div>
              <div class="spinner-arrow-bottom"></div>
              <div class="spinner-highlight"></div>
              <div class="spinner-track" id="freeSpinnerTrack"></div>
            </div>
            <div class="case-timer" id="freeCaseTimer"></div>
            <button class="case-spin-btn free-btn" id="freeSpinBtn" onclick="spinFreeCase()">
              КРУТИТЬ БЕСПЛАТНО
            </button>
            <div class="drops-title">Возможные призы</div>
            <div class="drops-grid" id="freeDropsGrid"></div>
          </div>
        </div>
      </div>

      <!-- ===== CRASH (ROCKET) SECTION ===== -->
      <div class="section" id="crashSection">
        <div class="crash-wrapper">
          <div class="history-row" id="crashHistoryRow"></div>
          <div class="crash-multiplier-display">
            <div class="crash-mult-value green" id="crashMultValue">1.00x</div>
            <div class="crash-mult-label" id="crashMultLabel">Ожидание...</div>
          </div>
          <div class="crash-chart-container" id="crashChartContainer">
            <div class="crash-bg-gif"><img src="https://i.postimg.cc/vTxyCnfx/0219.gif" alt=""></div>
            <div class="crash-bg-overlay"></div>
            <canvas id="crashCanvas"></canvas>
            <img class="crash-rocket-img" id="crashRocketImg" src="https://i.postimg.cc/QxvmXD36/Animated-Ag-ADyxs-AAte-Jk-Us.gif" alt="rocket">
            <img class="crash-explosion-img" id="crashExplosionImg" src="https://i.postimg.cc/1tmCZGqp/Animated-Ag-AD6x0AAs-KU6Es.gif" alt="explosion">
            <div class="countdown-overlay" id="crashCountdownOverlay">
              <div class="countdown-number" id="crashCountdownNumber">3</div>
              <div class="countdown-label">Запуск ракеты</div>
            </div>
          </div>
          <div class="timer-bar-wrap"><div class="timer-bar" id="crashTimerBar" style="width:100%"></div></div>
          <button class="action-btn play-btn" id="crashActionBtn" onclick="onCrashActionClick()">
            <span id="crashActionText">СДЕЛАТЬ СТАВКУ</span>
            <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="star">
          </button>
          <div class="players-panel">
            <div class="players-header">
              <div class="players-header-left" id="crashPlayersCount">0 игроков</div>
              <div class="players-header-right" id="crashPlayersTotalBets">
                0 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="">
              </div>
            </div>
            <div id="crashPlayersList"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-btn active" onclick="switchSection(0)" id="navHome">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
    Дом
  </button>
  <button class="nav-btn" onclick="switchSection(1)" id="navTrading">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m7 16 4-8 4 4 5-6"/></svg>
    Trading
  </button>
  <button class="nav-btn" onclick="switchSection(2)" id="navCases">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
    Кейсы
  </button>
  <button class="nav-btn" onclick="switchSection(3)" id="navCrash">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L4 20h16L12 2z"/><path d="M12 10v4"/></svg>
    Краш
  </button>
</div>

<!-- Bottom Sheet Backdrop -->
<div class="sheet-backdrop" id="sheetBackdrop"></div>
<!-- Bottom Sheet -->
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-content">
    <div class="sheet-handle-area" id="sheetHandle"><div class="sheet-handle"></div></div>
    <div class="sheet-title" id="sheetTitle">Сделать ставку</div>
    <div class="sheet-section-label">Сумма ставки</div>
    <div class="bet-options">
      <button class="bet-option" onclick="selectBet(10,this)">10 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt=""></button>
      <button class="bet-option" onclick="selectBet(25,this)">25 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt=""></button>
      <button class="bet-option" onclick="selectBet(50,this)">50 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt=""></button>
      <button class="bet-option" onclick="selectBet(100,this)">100 <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt=""></button>
    </div>
    <div class="sheet-section-label">Или введите свою</div>
    <div class="sheet-input-group">
      <input class="sheet-input" type="number" id="customBetInput" placeholder="Своя ставка (от 10)" min="10">
    </div>
    <div class="sheet-section-label">Авто-вывод</div>
    <div class="auto-cashout-sheet">
      <label>При:</label>
      <input type="number" id="autoCashoutInput" placeholder="напр. 2.50" step="0.1" min="1.1" value="">
      <span style="color:var(--text-dim);font-size:13px;font-weight:600;">x</span>
      <button class="auto-cashout-toggle" id="autoCashoutToggle" onclick="toggleAutoCashout()"></button>
    </div>
    <button class="sheet-confirm-btn" id="sheetConfirmBtn" onclick="confirmBet()">
      Подтвердить ставку
      <img class="star-icon" src="https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp" alt="">
    </button>
  </div>
</div>

<!-- Win popup for cases -->
<div class="win-popup" id="winPopup">
  <img id="winPopupImg" src="" alt="win">
  <div class="win-text" id="winPopupText">Победа!</div>
  <div class="win-amount" id="winPopupAmount"></div>
  <button class="win-popup-close" onclick="closeWinPopup()">Забрать</button>
</div>

<script>
// ========================
// CONSTANTS
// ========================
const STAR_IMG = 'https://nztcdn.com/files/6514f1e6-dab4-4d49-806a-3ff22d7793e5.webp';
const GIFT_IMG = 'https://telegrampodarki.ru/sites/default/files/inline-images/izobrazhenie_8.png';
const MOOD_CRASH = 'https://i.postimg.cc/3xCvPQJL/Animated-Ag-ADuhw-AAt-GFi-Uo.gif';
const MOOD_PLAY = 'https://i.postimg.cc/QxvmXD36/Animated-Ag-ADyxs-AAte-Jk-Us.gif';
const MOOD_WAIT = 'https://emojio.ru/images/apple-b/1f559.png';
const ROCKET_IMG_SRC = 'https://i.postimg.cc/QxvmXD36/Animated-Ag-ADyxs-AAte-Jk-Us.gif';
const EXPLOSION_IMG_SRC = 'https://i.postimg.cc/1tmCZGqp/Animated-Ag-AD6x0AAs-KU6Es.gif';

const PLAYER_NAMES = [
  'gigwq','okswiss','grabes','killo','higff','riwxc','mfbvc',
  'IlyaDepf','Fiigf','Limanaidovf','hahahahhahahahahah','moncleroff',
  'rickefg','rocketgift','obnalcontora','jrnd22',
  'xtr3me','blazeit420','noobslayer','cryptoboss','diamondhand',
  'moonboy99','yolotrade','degen_king','apefarm','wagmiLFG',
  'paperhands','ngmi_lol','pump_it_up','ruggedd','whale_alert',
  'Sergbets','Anon228','luckystar','betking77','cashflow_',
  'snipershoot','topG_trader','lambodriver','hodlgang','bearish_af',
  'starkiller','megawhale','profitmaxx','rugpull_ed','elon_fan42'
];

// ========================
// GLOBAL STATE
// ========================
let balance = 1000;
let currentSection = 0;
let betTarget = 'trading';
let playerUsername = '';

// ========================
// LOGIN
// ========================
const loginInput = document.getElementById('loginUsernameInput');
const loginBtn = document.getElementById('loginBtn');

loginInput.addEventListener('input', () => {
  const val = loginInput.value.trim();
  loginBtn.disabled = val.length < 2;
  const preview = document.getElementById('loginAvatarPreview');
  if (val.length > 0) {
    const clean = val.replace('@','');
    preview.textContent = clean[0] ? clean[0].toUpperCase() : '?';
  } else {
    preview.textContent = '?';
  }
});

function doLogin() {
  let val = loginInput.value.trim();
  if (val.length < 2) return;
  if (!val.startsWith('@')) val = '@' + val;
  playerUsername = val;
  localStorage.setItem('sg_username', val);
  document.getElementById('loginOverlay').classList.add('hidden');
  updateHomePlayer();
}

// Check saved username
(function checkSaved() {
  const saved = localStorage.getItem('sg_username');
  if (saved && saved.length > 1) {
    playerUsername = saved;
    document.getElementById('loginOverlay').classList.add('hidden');
    // defer updateHomePlayer
    setTimeout(updateHomePlayer, 50);
  }
})();

function updateHomePlayer() {
  const clean = playerUsername.replace('@','');
  document.getElementById('homeAvatar').textContent = clean[0] ? clean[0].toUpperCase() : '?';
  document.getElementById('homePlayerName').textContent = playerUsername;
  document.getElementById('homeBalance').textContent = balance;
}

// ========================
// DEPOSIT
// ========================
function openDeposit() {
  document.getElementById('depositOverlay').classList.add('visible');
  document.getElementById('depositInstructions').classList.remove('visible');
  document.querySelectorAll('.deposit-method').forEach(m => m.classList.remove('selected'));
}
function closeDeposit() {
  document.getElementById('depositOverlay').classList.remove('visible');
}
function selectDepositMethod(method) {
  document.querySelectorAll('.deposit-method').forEach(m => m.classList.remove('selected'));
  if (method === 'stars') {
    document.getElementById('depositMethodStars').classList.add('selected');
    document.getElementById('depositInstructions').classList.add('visible');
  }
}

// ========================
// SECTION SWITCHING (now 4 sections)
// ========================
function switchSection(idx) {
  currentSection = idx;
  document.getElementById('sectionsTrack').style.transform = `translateX(-${idx * 25}%)`;
  document.querySelectorAll('.nav-btn').forEach((b,i) => {
    b.classList.toggle('active', i === idx);
  });
}

// ========================
// CASES - open/close
// ========================
function openCase(type) {
  document.getElementById('casePreviews').style.display = 'none';
  if (type === 'free') {
    document.getElementById('freeCaseCard').classList.add('open');
  }
}
function closeCaseView() {
  document.getElementById('casePreviews').style.display = 'block';
  document.getElementById('freeCaseCard').classList.remove('open');
}

// ========================
// TRADING GAME
// ========================
let t_currentBet = 0;
let t_betPlaced = false;
let t_betForNextRound = 0;
let t_selectedBetAmount = 50;
let t_gameState = 'waiting';
let t_multiplier = 1.00;
let t_crashDuration = 0;
let t_gameStartTime = 0;
let t_roundHistory = [];
let t_autoCashoutEnabled = false;
let t_autoCashoutValue = 0;
let t_peakMultiplier = 1.00;
let t_candles = [];
let t_currentCandle = null;
let t_candleStartTime = 0;
const T_CANDLE_DURATION = 700;
let t_priceValue = 100;
let t_priceStart = 100;
let t_priceDirection = 1;
let t_priceMomentum = 0;
let t_priceVolatility = 0.6;
let t_lastPriceUpdate = 0;
let t_trendChangeTime = 0;
let t_speedBurstActive = false;
let t_speedBurstEnd = 0;
let t_nextSpeedBurst = 0;
let t_fakePlayers = [];
let t_roundCount = 0;
let t_youCashedOut = false;
let t_youCashoutMult = 0;
let t_youCashoutStars = 0;

const t_canvas = document.getElementById('chartCanvas');
const t_ctx = t_canvas.getContext('2d');

function t_generateCrashDuration() {
  const r = Math.random();
  if (r < 0.10) return 1000 + Math.random() * 2000;
  if (r < 0.30) return 3000 + Math.random() * 4000;
  if (r < 0.55) return 7000 + Math.random() * 8000;
  if (r < 0.78) return 15000 + Math.random() * 10000;
  if (r < 0.95) return 25000 + Math.random() * 15000;
  return 40000 + Math.random() * 20000;
}

function t_init() {
  t_resizeCanvas();
  window.addEventListener('resize', t_resizeCanvas);
  t_generateFakePlayers();
  t_renderPlayers();
  t_updateUI();
  t_startCountdown();
  requestAnimationFrame(t_draw);
}

function t_resizeCanvas() {
  const container = t_canvas.parentElement;
  const rect = container.getBoundingClientRect();
  t_canvas.width = rect.width * window.devicePixelRatio;
  t_canvas.height = rect.height * window.devicePixelRatio;
  t_ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
}

function t_startCountdown() {
  t_gameState = 'countdown';
  t_multiplier = 1.00;
  t_candles = [];
  t_currentCandle = null;
  t_youCashedOut = false;
  t_youCashoutMult = 0;
  t_youCashoutStars = 0;
  t_updateUI();

  const overlay = document.getElementById('countdownOverlay');
  const numEl = document.getElementById('countdownNumber');
  overlay.classList.add('visible');
  let count = 3;
  numEl.textContent = count;

  const interval = setInterval(() => {
    count--;
    if (count <= 0) {
      clearInterval(interval);
      overlay.classList.remove('visible');
      t_startRound();
    } else {
      numEl.textContent = count;
    }
  }, 1000);
}

function t_startRound() {
  t_roundCount++;
  t_crashDuration = t_generateCrashDuration();
  t_gameState = 'playing';
  t_multiplier = 1.00;
  t_peakMultiplier = 1.00;
  t_gameStartTime = performance.now();
  t_candleStartTime = performance.now();
  t_lastPriceUpdate = performance.now();
  t_candles = [];
  t_youCashedOut = false;
  t_youCashoutMult = 0;
  t_youCashoutStars = 0;

  t_priceStart = 100;
  t_priceValue = 100;
  t_priceDirection = Math.random() > 0.5 ? 1 : -1;
  t_priceMomentum = 1.5 + Math.random() * 2.0;
  t_priceVolatility = 2.0 + Math.random() * 1.5;
  t_trendChangeTime = performance.now() + 400 + Math.random() * 1200;

  t_speedBurstActive = false;
  t_nextSpeedBurst = performance.now() + 3000 + Math.random() * 5000;

  t_currentCandle = { open:t_priceValue, close:t_priceValue, high:t_priceValue, low:t_priceValue, bullish:true, x:0 };

  if (t_betForNextRound > 0) {
    t_currentBet = t_betForNextRound;
    t_betPlaced = true;
    t_betForNextRound = 0;
  }

  t_generateFakePlayers();
  t_renderPlayers();
  t_updateUI();
}

function t_updateGame(now) {
  if (t_gameState !== 'playing') return;

  const elapsed = now - t_gameStartTime;
  const dt = Math.min((now - t_lastPriceUpdate) / 1000, 0.1);
  t_lastPriceUpdate = now;

  const timeUntilCrash = t_crashDuration - elapsed;
  if (timeUntilCrash <= 0) {
    t_priceValue = 0;
    t_multiplier = 0.00;
    t_crash();
    return;
  }

  const isAboutToCrash = timeUntilCrash < 500;

  if (now > t_nextSpeedBurst && !t_speedBurstActive && !isAboutToCrash) {
    t_speedBurstActive = true;
    t_speedBurstEnd = now + 300 + Math.random() * 700;
  }
  if (t_speedBurstActive && now > t_speedBurstEnd) {
    t_speedBurstActive = false;
    t_nextSpeedBurst = now + 2000 + Math.random() * 6000;
  }

  if (isAboutToCrash) {
    const crashForce = (1 - timeUntilCrash / 500) * 8;
    t_priceValue -= t_priceValue * crashForce * dt;
    t_priceValue = Math.max(0, t_priceValue);
  } else {
    if (now > t_trendChangeTime) {
      t_priceDirection *= -1;
      t_priceMomentum = 1.5 + Math.random() * 2.5;
      t_priceVolatility = 2.0 + Math.random() * 2.0;
      t_trendChangeTime = now + 300 + Math.random() * 1000;
    }
    let speedMult = 1.0;
    if (t_speedBurstActive) {
      t_priceDirection = 1;
      speedMult = 3.0 + Math.random() * 2.0;
    }
    const noise = (Math.random() - 0.5) * t_priceVolatility * 4;
    const trend = t_priceDirection * t_priceMomentum * 1.5;
    t_priceValue += (trend + noise) * dt * t_priceValue * 0.08 * speedMult;
    t_priceValue = Math.max(15, t_priceValue);
  }

  t_multiplier = t_priceValue / t_priceStart;
  t_multiplier = Math.round(t_multiplier * 100) / 100;
  if (t_multiplier > t_peakMultiplier) t_peakMultiplier = t_multiplier;

  const pct = Math.max(0, 1 - elapsed / 60000);
  const tb = document.getElementById('timerBar');
  tb.style.width = (pct * 100) + '%';
  tb.style.background = t_multiplier < 0.5 ? 'var(--red)' : t_multiplier < 1.0 ? 'var(--gold)' : 'var(--green)';

  if (t_autoCashoutEnabled && t_betPlaced && t_multiplier >= t_autoCashoutValue) {
    t_cashOut();
    return;
  }

  const candleElapsed = now - t_candleStartTime;
  if (candleElapsed >= T_CANDLE_DURATION) {
    if (t_currentCandle) {
      t_currentCandle.close = t_priceValue;
      t_currentCandle.bullish = t_currentCandle.close >= t_currentCandle.open;
      t_candles.push({...t_currentCandle});
    }
    t_candleStartTime = now;
    t_currentCandle = { open:t_priceValue, close:t_priceValue, high:t_priceValue, low:t_priceValue, bullish:true, x:t_candles.length };
  } else if (t_currentCandle) {
    const n = (Math.random() - 0.5) * 3.0 * t_priceVolatility;
    const av = t_priceValue + n;
    t_currentCandle.close = t_priceValue;
    t_currentCandle.high = Math.max(t_currentCandle.high, av, t_priceValue);
    t_currentCandle.low = Math.min(t_currentCandle.low, av, t_priceValue);
    t_currentCandle.bullish = t_currentCandle.close >= t_currentCandle.open;
  }

  t_updateFakePlayers();
  t_updateUI();
}

function t_crash() {
  t_gameState = 'crashed';
  t_multiplier = 0.00;

  if (t_currentCandle) {
    t_currentCandle.close = 0;
    t_currentCandle.low = 0;
    t_currentCandle.bullish = false;
    t_candles.push({...t_currentCandle});
    t_currentCandle = null;
  }

  if (t_betPlaced) {
    t_betPlaced = false;
    t_currentBet = 0;
  }

  t_fakePlayers.forEach(p => {
    if (p.status === 'playing') { p.status = 'lost'; p.result = '0.00x'; p.cashoutStars = 0; }
  });

  t_roundHistory.unshift(t_peakMultiplier);
  if (t_roundHistory.length > 20) t_roundHistory.pop();
  t_renderHistory();
  t_renderPlayers();
  t_updateUI();

  setTimeout(() => t_startCountdown(), 3000);
}

function t_cashOut() {
  if (!t_betPlaced || t_gameState !== 'playing') return;
  const winnings = Math.floor(t_currentBet * t_multiplier);
  balance += winnings;
  t_youCashedOut = true;
  t_youCashoutMult = t_multiplier;
  t_youCashoutStars = winnings;
  t_betPlaced = false;

  showFloatingNick('You');

  const btn = document.getElementById('actionBtn');
  btn.style.background = 'var(--gold)';
  setTimeout(() => t_updateUI(), 600);
  t_renderPlayers();
  t_updateUI();
  updateHomePlayer();
}

function t_updateUI() {
  document.getElementById('balanceDisplay').textContent = balance;

  const valEl = document.getElementById('multiplierValue');
  const labelEl = document.getElementById('multiplierLabel');
  const btn = document.getElementById('actionBtn');
  const btnText = document.getElementById('actionText');
  const moodCards = [document.getElementById('mood1'),document.getElementById('mood2'),document.getElementById('mood3')];
  const moodImgs = moodCards.map(c => c.querySelector('img'));

  valEl.textContent = t_multiplier.toFixed(2) + 'x';
  valEl.className = 'multiplier-value';

  switch (t_gameState) {
    case 'waiting':
    case 'countdown':
      valEl.classList.add('green');
      labelEl.textContent = t_gameState === 'countdown' ? 'Раунд начинается...' : 'Ожидание...';
      btn.className = 'action-btn play-btn';
      btn.style.background = '';
      btnText.textContent = 'СДЕЛАТЬ СТАВКУ';
      moodCards.forEach(c => c.classList.remove('crash-mood'));
      moodImgs.forEach(img => { if (img.src !== MOOD_WAIT) img.src = MOOD_WAIT; });
      break;
    case 'playing':
      valEl.classList.add(t_multiplier >= 1.00 ? 'green' : 'red');
      const dir = t_multiplier >= 1.00 ? 'UP' : 'DOWN';
      if (t_betPlaced) {
        labelEl.textContent = `${dir} | Ставка: ${t_currentBet} | Выигрыш: ${Math.floor(t_currentBet * t_multiplier)}`;
        const isDown = t_multiplier < 1.00;
        btn.className = 'action-btn cashout-btn' + (isDown ? ' down' : '');
        btn.style.background = '';
        btnText.textContent = `ЗАБРАТЬ ${Math.floor(t_currentBet * t_multiplier)}`;
      } else if (t_youCashedOut) {
        labelEl.textContent = `${dir} | Забрали: ${t_youCashoutStars} при ${t_youCashoutMult.toFixed(2)}x`;
        btn.className = 'action-btn waiting-btn';
        btn.style.background = '';
        btnText.textContent = `Забрали ${t_youCashoutStars} при ${t_youCashoutMult.toFixed(2)}x`;
      } else if (t_betForNextRound > 0) {
        labelEl.textContent = `${dir} | Раунд идет`;
        btn.className = 'action-btn waiting-btn';
        btn.style.background = '';
        btnText.textContent = `Ставка ${t_betForNextRound} в след. раунде`;
      } else {
        labelEl.textContent = `${dir} | Раунд идет`;
        btn.className = 'action-btn play-btn';
        btn.style.background = '';
        btnText.textContent = 'СДЕЛАТЬ СТАВКУ';
      }
      moodCards.forEach(c => c.classList.remove('crash-mood'));
      moodImgs.forEach(img => { if (img.src !== MOOD_PLAY) img.src = MOOD_PLAY; });
      break;
    case 'crashed':
      valEl.classList.add('crashed');
      valEl.textContent = '0.00x';
      labelEl.textContent = 'КРАХ!';
      btn.className = 'action-btn crashed-btn';
      btn.style.background = '';
      btnText.textContent = 'КРАХ 0.00x';
      moodCards.forEach(c => c.classList.add('crash-mood'));
      break;
  }
}

// DRAWING - Trading candles start from middle
function t_draw() {
  const now = performance.now();
  t_updateGame(now);
  const w = t_canvas.width / window.devicePixelRatio;
  const h = t_canvas.height / window.devicePixelRatio;
  t_ctx.clearRect(0,0,w,h);
  t_drawGrid(w,h);
  t_drawCandles(w,h);
  requestAnimationFrame(t_draw);
}

function t_drawGrid(w,h) {
  t_ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  t_ctx.lineWidth = 0.5;
  for (let i=0;i<6;i++) { const y=(h/6)*(i+1); t_ctx.beginPath(); t_ctx.moveTo(0,y); t_ctx.lineTo(w,y); t_ctx.stroke(); }
  for (let i=0;i<8;i++) { const x=(w/8)*(i+1); t_ctx.beginPath(); t_ctx.moveTo(x,0); t_ctx.lineTo(x,h); t_ctx.stroke(); }
}

function t_drawCandles(w,h) {
  const all = [...t_candles];
  if (t_currentCandle) all.push(t_currentCandle);
  if (!all.length) return;

  let minV=Infinity, maxV=-Infinity;
  all.forEach(c => { minV=Math.min(minV,c.low); maxV=Math.max(maxV,c.high); });
  minV = Math.min(minV, t_priceStart*0.9);
  maxV = Math.max(maxV, t_priceStart*1.1);
  const range = maxV - minV || 0.1;
  minV -= range*0.15;
  maxV += range*0.15;
  minV = Math.max(0,minV);

  const total = all.length;
  const baseVis = 16;
  let maxVis;
  if (total <= baseVis) { maxVis = baseVis; }
  else { maxVis = Math.min(total, baseVis + Math.floor((total - baseVis) * 0.8)); }

  const startIdx = Math.max(0, total - maxVis);
  const vis = all.slice(startIdx);
  const areaW = w - 40;
  const cW = Math.max(areaW / maxVis, 4);
  const gap = Math.max(cW * 0.15, 1.5);
  const bW = Math.max(cW - gap, 2);

  const mapY = v => h - 20 - ((v - minV) / (maxV - minV)) * (h - 40);

  // Calculate offset to start candles from middle of screen
  const candlesWidth = vis.length * cW;
  let offsetX = 30;
  if (candlesWidth < areaW) {
    // Center / start from middle: offset so first candle appears at ~middle
    offsetX = Math.max(30, (w / 2) - candlesWidth + cW / 2);
  }

  // Start price line
  if (t_gameState === 'playing' || t_gameState === 'crashed') {
    const sy = mapY(t_priceStart);
    t_ctx.strokeStyle='rgba(255,255,255,0.15)'; t_ctx.lineWidth=0.5; t_ctx.setLineDash([2,4]);
    t_ctx.beginPath(); t_ctx.moveTo(0,sy); t_ctx.lineTo(w,sy); t_ctx.stroke(); t_ctx.setLineDash([]);
    t_ctx.font='500 9px Inter,sans-serif'; t_ctx.fillStyle='rgba(255,255,255,0.3)'; t_ctx.textAlign='right';
    t_ctx.fillText('1.00x',w-6,sy-4);
  }
  // Current price line
  if (t_gameState === 'playing') {
    const ly = mapY(t_priceValue);
    const isUp = t_multiplier >= 1.00;
    t_ctx.strokeStyle = isUp ? 'rgba(0,230,118,0.3)' : 'rgba(255,23,68,0.3)';
    t_ctx.lineWidth=1; t_ctx.setLineDash([4,4]);
    t_ctx.beginPath(); t_ctx.moveTo(0,ly); t_ctx.lineTo(w,ly); t_ctx.stroke(); t_ctx.setLineDash([]);
    t_ctx.font='600 11px Inter,sans-serif'; t_ctx.fillStyle = isUp ? '#00e676' : '#ff1744';
    t_ctx.textAlign='right'; t_ctx.fillText(t_multiplier.toFixed(2)+'x',w-6,ly-5);
  }
  // Candles
  vis.forEach((c,i) => {
    const x = offsetX + i*cW + cW/2;
    const oY=mapY(c.open), cY=mapY(c.close), hY=mapY(c.high), lY=mapY(c.low);
    const isG=c.bullish;
    const bCol = isG ? '#00e676' : '#ff1744';
    const wCol = isG ? '#00c853' : '#d50000';
    t_ctx.strokeStyle=wCol; t_ctx.lineWidth=Math.max(bW*0.12,1);
    t_ctx.beginPath(); t_ctx.moveTo(x,hY); t_ctx.lineTo(x,lY); t_ctx.stroke();
    const bTop=Math.min(oY,cY);
    const bH=Math.max(Math.abs(cY-oY), Math.max(bW*0.2,2));
    t_ctx.shadowColor=bCol; t_ctx.shadowBlur=Math.min(12,bW);
    t_ctx.fillStyle=bCol;
    t_ctx.beginPath(); t_ctx.roundRect(x-bW/2,bTop,bW,bH,Math.min(2,bW*0.1)); t_ctx.fill();
    t_ctx.shadowBlur=0;
  });
  // Y axis
  t_ctx.font='500 10px Inter,sans-serif'; t_ctx.fillStyle='rgba(255,255,255,0.25)'; t_ctx.textAlign='left';
  for (let i=0;i<=4;i++) { const v=minV+(maxV-minV)*(i/4); t_ctx.fillText(v.toFixed(1),2,mapY(v)-3); }
}

// FLOATING NICKS
function showFloatingNick(name) {
  const container = document.getElementById('floatingNicks');
  const chartRect = document.getElementById('chartContainer').getBoundingClientRect();
  const el = document.createElement('div');
  el.className = 'canvas-nick-float';
  el.textContent = name + ' забрал!';
  el.style.left = (20 + Math.random()*(chartRect.width-120))+'px';
  el.style.top = (10 + Math.random()*(chartRect.height-40))+'px';
  container.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => { el.classList.remove('show'); el.classList.add('hide'); }, 1500);
  setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); }, 2200);
}

// HISTORY
function t_renderHistory() {
  const row = document.getElementById('historyRow');
  row.innerHTML = '';
  t_roundHistory.forEach(val => {
    const chip = document.createElement('div');
    chip.className = 'history-chip ' + (val >= 1.5 ? 'green' : 'red');
    chip.textContent = val.toFixed(2) + 'x';
    row.appendChild(chip);
  });
}

// FAKE PLAYERS
function t_generateFakePlayers() {
  const count = 5 + Math.floor(Math.random()*6);
  t_fakePlayers = [];
  const used = new Set();
  for (let i=0;i<count;i++) {
    let name;
    do { name = PLAYER_NAMES[Math.floor(Math.random()*PLAYER_NAMES.length)]; } while(used.has(name));
    used.add(name);
    const bet = [10,25,50,100,200,500][Math.floor(Math.random()*6)];
    const cashoutMult = 0.7 + Math.random()*1.8;
    t_fakePlayers.push({ name, bet, status:'playing', cashoutAt:cashoutMult, result:'', cashoutStars:0, isYou:false });
  }
}

function t_updateFakePlayers() {
  t_fakePlayers.forEach(p => {
    if (p.status === 'playing' && t_multiplier >= p.cashoutAt && t_multiplier > 0.5) {
      p.status = 'won';
      p.result = t_multiplier.toFixed(2) + 'x';
      p.cashoutStars = Math.floor(p.bet * t_multiplier);
      showFloatingNick(p.name);
      t_renderPlayers();
    }
  });
}

function t_renderPlayers() {
  const list = document.getElementById('playersList');
  list.innerHTML = '';

  const allP = [...t_fakePlayers];
  const youBet = t_currentBet > 0 ? t_currentBet : t_betForNextRound;
  if (t_betPlaced || t_youCashedOut || t_betForNextRound > 0 || (t_gameState === 'crashed' && youBet > 0)) {
    let youStatus = 'playing';
    let youResult = '';
    let youCS = 0;

    if (t_youCashedOut) {
      youStatus = 'won';
      youResult = t_youCashoutMult.toFixed(2) + 'x';
      youCS = t_youCashoutStars;
    } else if (t_gameState === 'crashed') {
      youStatus = 'lost';
      youResult = '0.00x';
      youCS = 0;
    }

    allP.unshift({ name:'You', bet:youBet || t_currentBet, status:youStatus, result:youResult, cashoutStars:youCS, isYou:true });
  }

  document.getElementById('playersCount').textContent = allP.length + ' игроков';
  const totalBets = allP.reduce((s,p) => s + p.bet, 0);
  document.getElementById('playersTotalBets').innerHTML = totalBets + ' <img class="star-icon" src="'+STAR_IMG+'" alt="">';

  allP.forEach(p => {
    const row = document.createElement('div');
    row.className = 'player-row';
    if (p.isYou) row.classList.add('player-you');

    if (p.status === 'won') {
      if (p.isYou) row.classList.add('player-won-bg');
      else row.classList.add('player-won-bg');
    } else if (p.status === 'lost') {
      row.classList.add('player-lost-bg');
    }

    const avatarCls = p.isYou ? 'player-avatar you-avatar' : 'player-avatar';
    const nameCls = p.isYou ? 'player-name you-name' : 'player-name';
    const dName = p.isYou ? 'You' : p.name;

    let resultHtml = '';
    if (p.status === 'won') {
      const net = p.cashoutStars - p.bet;
      if (net >= 0) {
        resultHtml = `<div class="player-result win">+${net} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`;
      } else {
        resultHtml = `<div class="player-result lose">${net} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`;
      }
    } else if (p.status === 'lost') {
      resultHtml = `<div class="player-result lose">-${p.bet} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`;
    } else {
      resultHtml = `<div class="player-result playing">... </div>`;
    }

    let cashInfo = '';
    if (p.status === 'won') {
      const net = p.cashoutStars - p.bet;
      cashInfo = `<span class="player-cashout-info ${net >= 0 ? 'win' : 'lose'}">${p.result} = ${p.cashoutStars}</span>`;
    } else if (p.status === 'lost') {
      cashInfo = `<span class="player-cashout-info lose">0.00x</span>`;
    } else {
      cashInfo = `<span class="player-cashout-info playing">-</span>`;
    }

    row.innerHTML = `
      <div class="player-info">
        <div class="${avatarCls}">${dName[0].toUpperCase()}</div>
        <div>
          <div class="${nameCls}">${dName}</div>
          <div class="player-details">
            ${p.bet} <img class="star-icon" src="${STAR_IMG}" alt="">
            ${cashInfo}
          </div>
        </div>
      </div>
      ${resultHtml}
    `;
    list.appendChild(row);
  });
}

// ========================
// BET ACTIONS (shared sheet)
// ========================
let selectedBetAmount = 50;
let sheetOpen = false;
let sheetDragging = false;
let sheetStartY = 0;
let sheetCurrentY = 0;

function openBetModal(target) {
  betTarget = target || 'trading';
  document.getElementById('sheetTitle').textContent = betTarget === 'crash' ? 'Ставка на Краш' : 'Сделать ставку';
  const backdrop = document.getElementById('sheetBackdrop');
  const sheet = document.getElementById('bottomSheet');
  backdrop.classList.add('visible');
  sheet.classList.add('visible');
  sheet.style.transform = '';
  sheetOpen = true;
  document.querySelectorAll('.bet-option').forEach(b => b.classList.remove('selected'));
  document.getElementById('customBetInput').value = '';
}

function closeBetModal() {
  const backdrop = document.getElementById('sheetBackdrop');
  const sheet = document.getElementById('bottomSheet');
  backdrop.classList.remove('visible');
  sheet.classList.remove('visible');
  sheet.classList.remove('dragging');
  sheet.style.transform = '';
  sheetOpen = false;
}

function selectBet(amount,el) {
  selectedBetAmount = amount;
  document.querySelectorAll('.bet-option').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('customBetInput').value = '';
}

function confirmBet() {
  const customVal = parseInt(document.getElementById('customBetInput').value);
  const amount = customVal >= 10 ? customVal : selectedBetAmount;
  if (amount > balance) { alert('Недостаточно звезд!'); return; }
  closeBetModal();

  if (betTarget === 'crash') {
    c_betForNextRound = amount;
    balance -= amount;
    c_renderPlayers();
    c_updateUI();
  } else {
    t_betForNextRound = amount;
    balance -= amount;
    t_renderPlayers();
    t_updateUI();
  }
  updateHomePlayer();
}

function onActionClick() {
  if (t_gameState === 'playing' && t_betPlaced) {
    t_cashOut();
  } else if (!t_betPlaced && t_betForNextRound === 0 && !t_youCashedOut) {
    openBetModal('trading');
  }
}

function toggleAutoCashout() {
  const toggle = document.getElementById('autoCashoutToggle');
  const input = document.getElementById('autoCashoutInput');
  t_autoCashoutEnabled = !t_autoCashoutEnabled;
  if (t_autoCashoutEnabled) {
    const val = parseFloat(input.value);
    if (isNaN(val) || val < 1.1) { t_autoCashoutEnabled = false; return; }
    t_autoCashoutValue = val;
    toggle.classList.add('on');
  } else {
    toggle.classList.remove('on');
  }
}

// Sheet drag
(function initSheetDrag() {
  const handle = document.getElementById('sheetHandle');
  const sheet = document.getElementById('bottomSheet');
  const backdrop = document.getElementById('sheetBackdrop');
  function onStart(e) {
    if(!sheetOpen) return;
    sheetDragging=true; sheet.classList.add('dragging');
    sheetStartY = (e.touches?e.touches[0]:e).clientY; sheetCurrentY=0;
  }
  function onMove(e) {
    if(!sheetDragging) return;
    sheetCurrentY = Math.max(0,(e.touches?e.touches[0]:e).clientY - sheetStartY);
    sheet.style.transform = `translateY(${sheetCurrentY}px)`;
    backdrop.style.background = `rgba(0,0,0,${0.6*(1-Math.min(sheetCurrentY/300,1))})`;
  }
  function onEnd() {
    if(!sheetDragging) return; sheetDragging=false; sheet.classList.remove('dragging');
    if(sheetCurrentY>120) closeBetModal(); else { sheet.style.transform=''; backdrop.style.background=''; }
    sheetCurrentY=0;
  }
  handle.addEventListener('touchstart',onStart,{passive:true});
  handle.addEventListener('mousedown',onStart);
  document.addEventListener('touchmove',onMove,{passive:true});
  document.addEventListener('mousemove',onMove);
  document.addEventListener('touchend',onEnd);
  document.addEventListener('mouseup',onEnd);
  backdrop.addEventListener('click',() => { if(sheetOpen) closeBetModal(); });
})();

// ========================
// CASES
// ========================
const FREE_DROPS = [
  { img: STAR_IMG, label: '1', amount: 1, chance: 99 },
  { img: STAR_IMG, label: '10', amount: 10, chance: 0.9 },
  { img: STAR_IMG, label: '100', amount: 100, chance: 0.09 },
  { img: STAR_IMG, label: '500', amount: 500, chance: 0.009 },
  { img: GIFT_IMG, label: 'Gift', amount: 0, chance: 0.001, isGift: true },
];

let freeSpinning = false;
const FREE_COOLDOWN = 3 * 60 * 60 * 1000;
let lastFreeSpinTime = parseInt(localStorage.getItem('lastFreeSpin') || '0');

function initCases() {
  renderDropsGrid('freeDropsGrid', FREE_DROPS);
  populateSpinner('freeSpinnerTrack', FREE_DROPS);
  updateFreeCaseTimer();
  setInterval(updateFreeCaseTimer, 1000);
}

function renderDropsGrid(id, drops) {
  const grid = document.getElementById(id);
  grid.innerHTML = '';
  drops.forEach(d => {
    const el = document.createElement('div');
    el.className = 'drop-item';
    el.innerHTML = `
      <img src="${d.img}" alt="">
      <div class="drop-amount" style="color:${d.isGift ? 'var(--gold)' : d.amount >= 100 ? 'var(--green)' : 'var(--text)'}">${d.isGift ? 'Gift' : d.amount}</div>
      <div class="drop-chance">${d.chance}%</div>
    `;
    grid.appendChild(el);
  });
}

function populateSpinner(trackId, drops) {
  const track = document.getElementById(trackId);
  track.innerHTML = '';
  for (let i = 0; i < 60; i++) {
    const drop = pickDrop(drops);
    const item = document.createElement('div');
    item.className = 'spinner-item';
    item.innerHTML = `<img src="${drop.img}" alt=""><div class="item-label" style="color:${drop.isGift ? 'var(--gold)' : drop.amount >= 100 ? 'var(--green)' : 'var(--text)'}">${drop.isGift ? 'Gift' : drop.amount}</div>`;
    item.dataset.amount = drop.amount;
    item.dataset.isGift = drop.isGift || false;
    item.dataset.img = drop.img;
    track.appendChild(item);
  }
}

function pickDrop(drops) {
  const r = Math.random() * 100;
  let cumul = 0;
  for (const d of drops) {
    cumul += d.chance;
    if (r < cumul) return d;
  }
  return drops[0];
}

function pickWinDrop(drops) {
  const r = Math.random() * 100;
  let cumul = 0;
  for (const d of drops) {
    cumul += d.chance;
    if (r < cumul) return d;
  }
  return drops[0];
}

function updateFreeCaseTimer() {
  const btn = document.getElementById('freeSpinBtn');
  const timerEl = document.getElementById('freeCaseTimer');
  const now = Date.now();
  const elapsed = now - lastFreeSpinTime;

  if (elapsed < FREE_COOLDOWN && lastFreeSpinTime > 0) {
    const remaining = FREE_COOLDOWN - elapsed;
    const h = Math.floor(remaining / 3600000);
    const m = Math.floor((remaining % 3600000) / 60000);
    const s = Math.floor((remaining % 60000) / 1000);
    timerEl.textContent = `Доступно через: ${h}ч ${m}м ${s}с`;
    btn.disabled = true;
  } else {
    timerEl.textContent = '';
    btn.disabled = false;
  }
}

function spinCase(trackId, wrapperId, drops, onDone) {
  const track = document.getElementById(trackId);
  track.innerHTML = '';

  const winDrop = pickWinDrop(drops);
  const winIdx = 45;

  for (let i = 0; i < 60; i++) {
    let drop;
    if (i === winIdx) {
      drop = winDrop;
    } else {
      drop = pickDrop(drops);
    }
    const item = document.createElement('div');
    item.className = 'spinner-item';
    item.innerHTML = `<img src="${drop.img}" alt=""><div class="item-label" style="color:${drop.isGift ? 'var(--gold)' : drop.amount >= 100 ? 'var(--green)' : 'var(--text)'}">${drop.isGift ? 'Gift' : drop.amount}</div>`;
    track.appendChild(item);
  }

  const itemW = 90;
  const wrapperEl = document.getElementById(wrapperId);
  const wrapperW = wrapperEl.getBoundingClientRect().width;
  const targetX = winIdx * itemW + itemW / 2 - wrapperW / 2;
  const offset = (Math.random() - 0.5) * 40;

  track.style.transition = 'none';
  track.style.transform = 'translateX(0px)';

  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      track.style.transition = 'transform 4s cubic-bezier(0.15, 0.85, 0.35, 1)';
      track.style.transform = `translateX(-${targetX + offset}px)`;
    });
  });

  setTimeout(() => {
    onDone(winDrop);
  }, 4200);
}

function spinFreeCase() {
  if (freeSpinning) return;
  const now = Date.now();
  if (lastFreeSpinTime > 0 && (now - lastFreeSpinTime) < FREE_COOLDOWN) return;

  freeSpinning = true;
  document.getElementById('freeSpinBtn').disabled = true;

  spinCase('freeSpinnerTrack', 'freeSpinnerWrapper', FREE_DROPS, (win) => {
    freeSpinning = false;
    lastFreeSpinTime = Date.now();
    localStorage.setItem('lastFreeSpin', lastFreeSpinTime.toString());

    if (win.isGift) {
      showWinPopup(win.img, 'Gift!', '');
    } else {
      balance += win.amount;
      document.getElementById('balanceDisplay').textContent = balance;
      showWinPopup(win.img, `+${win.amount}`, 'звезд');
    }
    updateFreeCaseTimer();
    updateHomePlayer();
  });
}

function showWinPopup(img, text, sub) {
  const popup = document.getElementById('winPopup');
  document.getElementById('winPopupImg').src = img;
  document.getElementById('winPopupText').textContent = text;
  document.getElementById('winPopupAmount').innerHTML = sub ? `${sub} <img class="star-icon" src="${STAR_IMG}" alt="">` : '';
  popup.classList.add('visible');
}

function closeWinPopup() {
  document.getElementById('winPopup').classList.remove('visible');
}

// ========================
// CRASH (ROCKET) GAME
// ========================
let c_gameState = 'waiting';
let c_multiplier = 1.00;
let c_crashPoint = 1.00;
let c_gameStartTime = 0;
let c_currentBet = 0;
let c_betPlaced = false;
let c_betForNextRound = 0;
let c_youCashedOut = false;
let c_youCashoutMult = 0;
let c_youCashoutStars = 0;
let c_fakePlayers = [];
let c_roundHistory = [];
let c_rocketY = 0;
let c_rocketX = 0;
let c_explosionTime = 0;

const c_canvas = document.getElementById('crashCanvas');
const c_ctx = c_canvas.getContext('2d');

// Rocket & explosion image elements
const crashRocketEl = document.getElementById('crashRocketImg');
const crashExplosionEl = document.getElementById('crashExplosionImg');

function c_generateCrashPoint() {
  const r = Math.random();
  if (r < 0.10) return 1.0 + Math.random() * 0.3;
  if (r < 0.30) return 1.3 + Math.random() * 0.5;
  if (r < 0.55) return 1.8 + Math.random() * 1.2;
  if (r < 0.78) return 3.0 + Math.random() * 2.0;
  if (r < 0.95) return 5.0 + Math.random() * 5.0;
  return 10.0 + Math.random() * 20.0;
}

function c_init() {
  c_resizeCanvas();
  window.addEventListener('resize', c_resizeCanvas);
  c_generateFakePlayers();
  c_renderPlayers();
  c_updateUI();
  c_startCountdown();
  requestAnimationFrame(c_draw);
}

function c_resizeCanvas() {
  const container = c_canvas.parentElement;
  const rect = container.getBoundingClientRect();
  c_canvas.width = rect.width * window.devicePixelRatio;
  c_canvas.height = rect.height * window.devicePixelRatio;
  c_ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
}

function c_startCountdown() {
  c_gameState = 'countdown';
  c_multiplier = 1.00;
  c_youCashedOut = false;
  c_youCashoutMult = 0;
  c_youCashoutStars = 0;
  crashRocketEl.style.display = 'none';
  crashExplosionEl.classList.remove('visible');
  c_updateUI();

  const overlay = document.getElementById('crashCountdownOverlay');
  const numEl = document.getElementById('crashCountdownNumber');
  overlay.classList.add('visible');
  let count = 3;
  numEl.textContent = count;

  const interval = setInterval(() => {
    count--;
    if (count <= 0) {
      clearInterval(interval);
      overlay.classList.remove('visible');
      c_startRound();
    } else {
      numEl.textContent = count;
    }
  }, 1000);
}

function c_startRound() {
  c_crashPoint = c_generateCrashPoint();
  c_gameState = 'playing';
  c_multiplier = 1.00;
  c_gameStartTime = performance.now();
  c_youCashedOut = false;
  c_youCashoutMult = 0;
  c_youCashoutStars = 0;

  crashRocketEl.style.display = 'block';
  crashExplosionEl.classList.remove('visible');

  if (c_betForNextRound > 0) {
    c_currentBet = c_betForNextRound;
    c_betPlaced = true;
    c_betForNextRound = 0;
  }

  c_generateFakePlayers();
  c_renderPlayers();
  c_updateUI();
}

function c_updateGame(now) {
  if (c_gameState !== 'playing') return;

  const elapsed = (now - c_gameStartTime) / 1000;
  // Multiplier grows 1.8x faster: 0.06 * 1.8 = 0.108
  c_multiplier = Math.pow(Math.E, 0.108 * elapsed);
  c_multiplier = Math.round(c_multiplier * 100) / 100;

  if (c_multiplier >= c_crashPoint) {
    c_multiplier = c_crashPoint;
    c_crash(now);
    return;
  }

  // Timer bar
  const pct = Math.max(0, 1 - elapsed / 60);
  const tb = document.getElementById('crashTimerBar');
  tb.style.width = (pct * 100) + '%';
  tb.style.background = 'var(--green)';

  // Auto cashout
  if (t_autoCashoutEnabled && c_betPlaced && c_multiplier >= t_autoCashoutValue) {
    c_cashOut();
    return;
  }

  c_updateFakePlayers();
  c_updateUI();
}

function c_crash(now) {
  c_gameState = 'crashed';
  c_explosionTime = now;

  // Hide rocket, show explosion
  crashRocketEl.style.display = 'none';
  crashExplosionEl.style.left = crashRocketEl.style.left;
  crashExplosionEl.style.top = crashRocketEl.style.top;
  crashExplosionEl.classList.add('visible');

  if (c_betPlaced) {
    c_betPlaced = false;
    c_currentBet = 0;
  }

  c_fakePlayers.forEach(p => {
    if (p.status === 'playing') { p.status = 'lost'; p.result = '0.00x'; p.cashoutStars = 0; }
  });

  c_roundHistory.unshift(c_crashPoint);
  if (c_roundHistory.length > 20) c_roundHistory.pop();
  c_renderCrashHistory();
  c_renderPlayers();
  c_updateUI();

  setTimeout(() => c_startCountdown(), 3000);
}

function c_cashOut() {
  if (!c_betPlaced || c_gameState !== 'playing') return;
  const winnings = Math.floor(c_currentBet * c_multiplier);
  balance += winnings;
  c_youCashedOut = true;
  c_youCashoutMult = c_multiplier;
  c_youCashoutStars = winnings;
  c_betPlaced = false;
  c_renderPlayers();
  c_updateUI();
  updateHomePlayer();
}

function c_updateUI() {
  document.getElementById('balanceDisplay').textContent = balance;
  const valEl = document.getElementById('crashMultValue');
  const labelEl = document.getElementById('crashMultLabel');
  const btn = document.getElementById('crashActionBtn');
  const btnText = document.getElementById('crashActionText');

  valEl.textContent = c_multiplier.toFixed(2) + 'x';
  valEl.className = 'crash-mult-value';

  switch (c_gameState) {
    case 'waiting':
    case 'countdown':
      valEl.classList.add('green');
      labelEl.textContent = c_gameState === 'countdown' ? 'Запуск...' : 'Ожидание...';
      btn.className = 'action-btn play-btn';
      btn.style.background = '';
      btnText.textContent = 'СДЕЛАТЬ СТАВКУ';
      break;
    case 'playing':
      valEl.classList.add('green');
      if (c_betPlaced) {
        labelEl.textContent = `Ставка: ${c_currentBet} | Выигрыш: ${Math.floor(c_currentBet * c_multiplier)}`;
        btn.className = 'action-btn cashout-btn';
        btn.style.background = '';
        btnText.textContent = `ЗАБРАТЬ ${Math.floor(c_currentBet * c_multiplier)}`;
      } else if (c_youCashedOut) {
        labelEl.textContent = `Забрали: ${c_youCashoutStars} при ${c_youCashoutMult.toFixed(2)}x`;
        btn.className = 'action-btn waiting-btn';
        btn.style.background = '';
        btnText.textContent = `Забрали ${c_youCashoutStars}`;
      } else if (c_betForNextRound > 0) {
        labelEl.textContent = 'Ракета летит!';
        btn.className = 'action-btn waiting-btn';
        btn.style.background = '';
        btnText.textContent = `Ставка ${c_betForNextRound} в след. раунде`;
      } else {
        labelEl.textContent = 'Ракета летит!';
        btn.className = 'action-btn play-btn';
        btn.style.background = '';
        btnText.textContent = 'СДЕЛАТЬ СТАВКУ';
      }
      break;
    case 'crashed':
      valEl.classList.add('red');
      labelEl.textContent = 'ВЗРЫВ!';
      btn.className = 'action-btn crashed-btn';
      btn.style.background = '';
      btnText.textContent = `ВЗРЫВ ${c_crashPoint.toFixed(2)}x`;
      break;
  }
}

function c_draw() {
  const now = performance.now();
  c_updateGame(now);

  const w = c_canvas.width / window.devicePixelRatio;
  const h = c_canvas.height / window.devicePixelRatio;
  c_ctx.clearRect(0, 0, w, h);

  // Draw grid
  c_ctx.strokeStyle = 'rgba(255,255,255,0.035)';
  c_ctx.lineWidth = 0.5;
  for (let i = 0; i < 8; i++) { const y = (h/8)*(i+1); c_ctx.beginPath(); c_ctx.moveTo(0,y); c_ctx.lineTo(w,y); c_ctx.stroke(); }
  for (let i = 0; i < 8; i++) { const x = (w/8)*(i+1); c_ctx.beginPath(); c_ctx.moveTo(x,0); c_ctx.lineTo(x,h); c_ctx.stroke(); }

  if (c_gameState === 'playing' || c_gameState === 'crashed') {
    const progress = c_gameState === 'crashed' ? 1 : Math.min((c_multiplier - 1) / (c_crashPoint > 3 ? c_crashPoint * 0.8 : 3), 0.95);

    // Rocket position - straight diagonal line
    const startX = 30;
    const startY = h - 30;
    const endX = w - 40;
    const endY = 40;
    c_rocketX = startX + progress * (endX - startX);
    c_rocketY = startY + progress * (endY - startY);

    // Draw green glow line (thick, straight)
    // Glow layer
    c_ctx.save();
    c_ctx.strokeStyle = 'rgba(0,230,118,0.15)';
    c_ctx.lineWidth = 12;
    c_ctx.lineCap = 'round';
    c_ctx.beginPath();
    c_ctx.moveTo(startX, startY);
    c_ctx.lineTo(c_rocketX, c_rocketY);
    c_ctx.stroke();
    // Main line
    c_ctx.strokeStyle = '#00e676';
    c_ctx.lineWidth = 4;
    c_ctx.shadowColor = '#00e676';
    c_ctx.shadowBlur = 16;
    c_ctx.beginPath();
    c_ctx.moveTo(startX, startY);
    c_ctx.lineTo(c_rocketX, c_rocketY);
    c_ctx.stroke();
    c_ctx.shadowBlur = 0;
    c_ctx.restore();

    // Draw filled area under the line
    c_ctx.save();
    const grad = c_ctx.createLinearGradient(0, endY, 0, startY);
    grad.addColorStop(0, 'rgba(0,230,118,0.18)');
    grad.addColorStop(1, 'rgba(0,230,118,0.01)');
    c_ctx.fillStyle = grad;
    c_ctx.beginPath();
    c_ctx.moveTo(startX, startY);
    c_ctx.lineTo(c_rocketX, c_rocketY);
    c_ctx.lineTo(c_rocketX, startY);
    c_ctx.closePath();
    c_ctx.fill();
    c_ctx.restore();

    // Position rocket image element (GIF)
    const percX = (c_rocketX / w) * 100;
    const percY = (c_rocketY / h) * 100;

    // Calculate rocket tilt - gradually tilts upward as it flies higher
    const tiltAngle = -15 - progress * 45; // from -15deg to -60deg (tilting nose up)

    if (c_gameState === 'playing') {
      crashRocketEl.style.left = percX + '%';
      crashRocketEl.style.top = percY + '%';
      crashRocketEl.style.display = 'block';
      crashRocketEl.style.transform = 'translate(-50%,-50%) rotate(' + tiltAngle + 'deg)';

      // Multiplier text on canvas near rocket
      c_ctx.font = '800 22px Inter, sans-serif';
      c_ctx.fillStyle = '#fff';
      c_ctx.textAlign = 'center';
      c_ctx.shadowColor = 'rgba(0,0,0,0.7)';
      c_ctx.shadowBlur = 8;
      c_ctx.fillText(c_multiplier.toFixed(2) + 'x', c_rocketX, c_rocketY - 110);
      c_ctx.shadowBlur = 0;
    }

    // Explosion
    if (c_gameState === 'crashed') {
      crashExplosionEl.style.left = percX + '%';
      crashExplosionEl.style.top = percY + '%';

      // Crash text
      c_ctx.font = '900 36px Inter, sans-serif';
      c_ctx.fillStyle = '#ff1744';
      c_ctx.textAlign = 'center';
      c_ctx.shadowColor = 'rgba(255,23,68,0.6)';
      c_ctx.shadowBlur = 20;
      c_ctx.fillText('ВЗРЫВ!', w / 2, h / 2 - 10);
      c_ctx.font = '700 24px Inter, sans-serif';
      c_ctx.fillText(c_crashPoint.toFixed(2) + 'x', w / 2, h / 2 + 28);
      c_ctx.shadowBlur = 0;
    }
  } else {
    crashRocketEl.style.display = 'none';
    crashExplosionEl.classList.remove('visible');
    // Waiting/countdown
    c_ctx.font = '600 16px Inter, sans-serif';
    c_ctx.fillStyle = 'rgba(255,255,255,0.3)';
    c_ctx.textAlign = 'center';
    c_ctx.fillText('Ожидание запуска...', w / 2, h / 2);
  }

  requestAnimationFrame(c_draw);
}

function c_generateFakePlayers() {
  const count = 5 + Math.floor(Math.random() * 6);
  c_fakePlayers = [];
  const used = new Set();
  for (let i = 0; i < count; i++) {
    let name;
    do { name = PLAYER_NAMES[Math.floor(Math.random() * PLAYER_NAMES.length)]; } while (used.has(name));
    used.add(name);
    const bet = [10, 25, 50, 100, 200, 500][Math.floor(Math.random() * 6)];
    const cashoutMult = 1.1 + Math.random() * (c_crashPoint > 2 ? c_crashPoint * 0.7 : 1.5);
    c_fakePlayers.push({ name, bet, status: 'playing', cashoutAt: cashoutMult, result: '', cashoutStars: 0, isYou: false });
  }
}

function c_updateFakePlayers() {
  c_fakePlayers.forEach(p => {
    if (p.status === 'playing' && c_multiplier >= p.cashoutAt) {
      p.status = 'won';
      p.result = c_multiplier.toFixed(2) + 'x';
      p.cashoutStars = Math.floor(p.bet * c_multiplier);
      c_renderPlayers();
    }
  });
}

function c_renderPlayers() {
  const list = document.getElementById('crashPlayersList');
  list.innerHTML = '';

  const allP = [...c_fakePlayers];
  const youBet = c_currentBet > 0 ? c_currentBet : c_betForNextRound;
  if (c_betPlaced || c_youCashedOut || c_betForNextRound > 0 || (c_gameState === 'crashed' && youBet > 0)) {
    let youStatus = 'playing';
    let youResult = '';
    let youCS = 0;
    if (c_youCashedOut) {
      youStatus = 'won';
      youResult = c_youCashoutMult.toFixed(2) + 'x';
      youCS = c_youCashoutStars;
    } else if (c_gameState === 'crashed') {
      youStatus = 'lost';
      youResult = '0.00x';
      youCS = 0;
    }
    allP.unshift({ name: 'You', bet: youBet || c_currentBet, status: youStatus, result: youResult, cashoutStars: youCS, isYou: true });
  }

  document.getElementById('crashPlayersCount').textContent = allP.length + ' игроков';
  const totalBets = allP.reduce((s, p) => s + p.bet, 0);
  document.getElementById('crashPlayersTotalBets').innerHTML = totalBets + ' <img class="star-icon" src="' + STAR_IMG + '" alt="">';

  allP.forEach(p => {
    const row = document.createElement('div');
    row.className = 'player-row';
    if (p.isYou) row.classList.add('player-you');
    if (p.status === 'won') row.classList.add('player-won-bg');
    else if (p.status === 'lost') row.classList.add('player-lost-bg');

    const avatarCls = p.isYou ? 'player-avatar you-avatar' : 'player-avatar';
    const nameCls = p.isYou ? 'player-name you-name' : 'player-name';
    const dName = p.isYou ? 'You' : p.name;

    let resultHtml = '';
    if (p.status === 'won') {
      const net = p.cashoutStars - p.bet;
      resultHtml = net >= 0
        ? `<div class="player-result win">+${net} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`
        : `<div class="player-result lose">${net} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`;
    } else if (p.status === 'lost') {
      resultHtml = `<div class="player-result lose">-${p.bet} <img class="star-icon" src="${STAR_IMG}" alt=""></div>`;
    } else {
      resultHtml = `<div class="player-result playing">...</div>`;
    }

    let cashInfo = '';
    if (p.status === 'won') {
      const net = p.cashoutStars - p.bet;
      cashInfo = `<span class="player-cashout-info ${net >= 0 ? 'win' : 'lose'}">${p.result} = ${p.cashoutStars}</span>`;
    } else if (p.status === 'lost') {
      cashInfo = `<span class="player-cashout-info lose">0.00x</span>`;
    } else {
      cashInfo = `<span class="player-cashout-info playing">-</span>`;
    }

    row.innerHTML = `
      <div class="player-info">
        <div class="${avatarCls}">${dName[0].toUpperCase()}</div>
        <div>
          <div class="${nameCls}">${dName}</div>
          <div class="player-details">${p.bet} <img class="star-icon" src="${STAR_IMG}" alt=""> ${cashInfo}</div>
        </div>
      </div>
      ${resultHtml}
    `;
    list.appendChild(row);
  });
}

function c_renderCrashHistory() {
  const row = document.getElementById('crashHistoryRow');
  row.innerHTML = '';
  c_roundHistory.forEach(val => {
    const chip = document.createElement('div');
    chip.className = 'history-chip ' + (val >= 2.0 ? 'green' : 'red');
    chip.textContent = val.toFixed(2) + 'x';
    row.appendChild(chip);
  });
}

function onCrashActionClick() {
  if (c_gameState === 'playing' && c_betPlaced) {
    c_cashOut();
  } else if (!c_betPlaced && c_betForNextRound === 0 && !c_youCashedOut) {
    openBetModal('crash');
  }
}

// ========================
// POLYFILL roundRect
// ========================
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r) {
    if(w<2*r) r=w/2; if(h<2*r) r=h/2;
    this.moveTo(x+r,y);
    this.arcTo(x+w,y,x+w,y+h,r);
    this.arcTo(x+w,y+h,x,y+h,r);
    this.arcTo(x,y+h,x,y,r);
    this.arcTo(x,y,x+w,y,r);
    this.closePath();
    return this;
  };
}

// ========================
// INIT ALL
// ========================
t_init();
c_init();
initCases();

// ========================
// TELEGRAM AUTO LOGIN
// ========================

let telegramUserId = null;

function initTelegramAuth() {

  if (window.Telegram && window.Telegram.WebApp) {

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const user = tg.initDataUnsafe?.user;

    if (user) {

      telegramUserId = user.id;

      if (user.username) {
        playerUsername = '@' + user.username;
      } else {
        playerUsername = user.first_name;
      }

      localStorage.setItem('sg_username', playerUsername);
      localStorage.setItem('sg_userid', telegramUserId);

      const overlay = document.getElementById('loginOverlay');
      if (overlay) overlay.classList.add('hidden');

      if (typeof updateHomePlayer === "function") {
        updateHomePlayer();
      }

      console.log('Telegram auth success:', user);
      return;
    }
  }

  fallbackLogin();
}

function fallbackLogin() {
  const saved = localStorage.getItem('sg_username');

  if (saved && saved.length > 1) {
    playerUsername = saved;
    const overlay = document.getElementById('loginOverlay');
    if (overlay) overlay.classList.add('hidden');

    if (typeof updateHomePlayer === "function") {
      setTimeout(updateHomePlayer, 50);
    }
  }
}

document.addEventListener("DOMContentLoaded", function() {
  initTelegramAuth();
});

</script>
</body>
</html>
